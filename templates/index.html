<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI å¥³å‹é™ªä¼´ç³»ç»Ÿ</title>
<link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="main-layout">
    <div class="waifu-container">
        <div id="live2d-widget"></div>
    </div>

    <div class="chat-container">
        <header class="chat-header">
            <h1>ğŸ’—</h1>
            <div class="personality">
                <label>æ€§æ ¼ï¼š</label>
                <select id="personality" onchange="changePersonality()">
                    <option value="clingy">é»äºº</option>
                    <option value="cool">é«˜å†·</option>
                    <option value="wise">çŸ¥æ€§</option>
                </select>
            </div>
            <div class="waifu-model">
                <label>å½¢è±¡ï¼š</label>
                <select id="waifuModel" onchange="changeWaifuModel()">
                    <option value="miku">åˆéŸ³</option>
                    <option value="haru">å…ƒæ°”</option>
                    <option value="hijiki">çŒ«å¨˜</option>
                </select>
            </div>
            <div class="persona-extra">
                <label>äººè®¾è¡¥å……ï¼š</label>
                <input id="personaDetail" placeholder="ä¾‹å¦‚ï¼šå‚²å¨‡ã€çˆ±åƒé†‹ã€ä¼šæé†’æˆ‘ä¼‘æ¯" />
            </div>
        </header>

        <div id="chatbox" class="chat-box">
            <div class="ai msg">ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·å‘€ï½</div>
        </div>

        <div class="input-area">
            <input id="msg" placeholder="å’Œå¥¹è¯´ç‚¹ä»€ä¹ˆâ€¦" />
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>
</div>

<script>
async function sendMessage() {
    const input = document.getElementById("msg");
    const text = input.value.trim();
    if (!text) return;
    input.value = "";

    const chatbox = document.getElementById("chatbox");
    chatbox.innerHTML += `<div class="user msg">${text}</div>`;
    chatbox.scrollTop = chatbox.scrollHeight;

    const res = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: text})
    });
    const data = await res.json();
    chatbox.innerHTML += `<div class="ai msg">${data.reply}</div>`;
    chatbox.scrollTop = chatbox.scrollHeight;
}

async function changePersonality() {
    const sel = document.getElementById("personality").value;
    const extra = document.getElementById("personaDetail").value.trim();
    await fetch("/set_personality", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({personality: sel, persona_detail: extra})
    });
    const chatbox = document.getElementById("chatbox");
    let text = `æ€§æ ¼å·²åˆ‡æ¢ä¸ºï¼š${sel}`;
    if (extra) {
        text += `ï¼ˆäººè®¾ï¼š${extra}ï¼‰`;
    }
    chatbox.innerHTML += `<div class="ai msg system">${text}</div>`;
    chatbox.scrollTop = chatbox.scrollHeight;
}

// å›è½¦å‘é€
document.getElementById("msg").addEventListener("keydown", function(e){
    if(e.key === "Enter") sendMessage();
});
</script>

<!-- 3D çœ‹æ¿å¨˜ï¼ˆLive2Dï¼‰ -->
<script src="https://unpkg.com/live2d-widget@3.1.4/lib/L2Dwidget.min.js"></script>
<script>
const WAIFU_MODELS = {
    miku: "https://unpkg.com/live2d-widget-model-miku@1.0.5/assets/miku.model.json",
    haru: "https://unpkg.com/live2d-widget-model-haru@1.0.5/assets/haru01.model.json",
    hijiki: "https://unpkg.com/live2d-widget-model-hijiki@1.0.5/assets/hijiki.model.json"
};

function loadWaifuModel(key) {
    const jsonPath = WAIFU_MODELS[key] || WAIFU_MODELS.miku;
    L2Dwidget.init({
        model: { jsonPath: jsonPath },
        display: {
            position: "left",
            width: 400,
            height: 600,
            hOffset: 0,
            vOffset: 0
        },
        mobile: {
            show: true,
            scale: 0.5
        },
        react: {
            opacityDefault: 0.9,
            opacityOnHover: 1
        }
    });
    // å°è¯•åœ¨æ¨¡å‹åŠ è½½åç»‘å®šè§¦æ‘¸äº‹ä»¶
    setTimeout(function() {
        bindWaifuTouch();
    }, 1000);
}

function changeWaifuModel() {
    const sel = document.getElementById("waifuModel").value;
    loadWaifuModel(sel);
}

function bindWaifuTouch() {
    // live2d-widget é»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ª id ä¸º live2dcanvas çš„ canvas
    const canvas = document.getElementById("live2dcanvas");
    if (!canvas) return;

    const chatbox = document.getElementById("chatbox");
    if (!chatbox) return;

    async function handleTouch(event) {
        const rect = canvas.getBoundingClientRect();
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;
        const yRatio = (clientY - rect.top) / rect.height; // 0 é¡¶éƒ¨ï¼Œ1 åº•éƒ¨

        let touchDesc;
        if (yRatio < 0.33) {
            touchDesc = "[è§¦æ‘¸äº‹ä»¶] æˆ‘åˆšåˆšè½»è½»æ‘¸äº†æ‘¸ä½ çš„å¤´å‘ï¼Œä½ ä¼šæ€ä¹ˆå›åº”ï¼Ÿ";
        } else if (yRatio < 0.66) {
            touchDesc = "[è§¦æ‘¸äº‹ä»¶] æˆ‘åˆšåˆšè½»è½»æŠ±äº†ä¸€ä¸‹ä½ ï¼Œä½ ä¼šæ€ä¹ˆå›åº”ï¼Ÿ";
        } else {
            touchDesc = "[è§¦æ‘¸äº‹ä»¶] æˆ‘åˆšåˆšæœ‰ç‚¹å¤§èƒ†åœ°æ‘¸äº†ä½ æ¯”è¾ƒæ•æ„Ÿçš„åœ°æ–¹ï¼Œä½ ä¼šæ€ä¹ˆå›åº”ï¼Ÿè¯·ç”¨ä¿çš®ä½†ä¸è¿‡åˆ†çš„æ–¹å¼è¡¨è¾¾ä½ çš„ååº”ã€‚";
        }

        try {
            const res = await fetch("/chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message: touchDesc})
            });
            const data = await res.json();
            if (data && data.reply) {
                chatbox.innerHTML += `<div class="ai msg">${data.reply}</div>`;
                chatbox.scrollTop = chatbox.scrollHeight;
            }
        } catch (e) {
            // è§¦æ‘¸è§¦å‘å¤±è´¥æ—¶é™é»˜å¿½ç•¥
        }
    }

    canvas.onclick = handleTouch;
    canvas.ontouchstart = handleTouch;
}

loadWaifuModel("miku");
</script>
</body>
</html>
